<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="favicon" href="favicon.ico" type="image/x-icon">
<title>T-Review</title>
<link rel="stylesheet" href="css/style.css">
</head>
<body>
<div class="background"><img src="/img/background.jpg" alt=""></div>
<div class="container">
    <div class="box">
        <img src="https://cf.shopee.sg/file/myCollection-default-background.png" alt="" class="bg-image">
        <div class="search-box">
            <i class="icon-search"></i>
            <form id="searchForm">
                <input type="search" id="searchInput" placeholder="T√¨m ki·∫øm ƒë∆∞·ªùng d·∫´n" value="">
            </form>
        </div>
        <div class="profile">
            <div class="avatar"><img src="img/TReview.png" alt=""></div>
            <div class="info">          
                <h2>T-Review</h2>
                <p>M·ªôt s·ªë v·∫≠t d·ª•ng hay ho v√† h·ªØu √≠ch</p>
            </div>
        </div>
    </div>

    <div class="tags" id="tags"></div>
    <div class="more-tag" id="toggleTags">
        <div class="arr-down"><span></span></div>
        <div class="text">Xem th√™m</div>    
    </div>

    <div class="products" id="products"></div>

    <div class="pagination" id="pagination"></div>
</div>
</body>

<script>
const tagContainer = document.getElementById('tags');
const productContainer = document.getElementById('products');
const paginationContainer = document.getElementById('pagination');
const searchForm = document.getElementById('searchForm');
const searchInput = document.getElementById('searchInput');
let renderSessionId = 0;

const productsPerPage = 10;
let productsData = [];
let currentPage = 1;
let filteredProducts = [];

// ‚úÖ Render 1 s·∫£n ph·∫©m
function renderProduct(data) {
    const product = document.createElement("div");
    product.className = "product";
    if (data.key) product.dataset.key = data.key;

    product.innerHTML = `
        <a href="${data.url}" target="_blank" class="thumb">
            <img src="${data.image || 'img/no-image.png'}" alt="${data.title}" loading="lazy">
        </a>
        <div class="info">
            <div class="title">${data.title}</div>
            <div class="link"><a href="${data.url}" target="_blank">üîó Xem s·∫£n ph·∫©m</a></div>
        </div>
    `;
    productContainer.appendChild(product);
}

// ‚úÖ Fetch meta Shopee
async function fetchAndRender(url, key = '') {
    try {
        const res = await fetch(`/api/get-meta?url=${encodeURIComponent(url)}`);
        const data = await res.json();

        if (data.error) {
            renderProduct({ title: "Kh√¥ng t√¨m th·∫•y ti√™u ƒë·ªÅ", url, image: "img/no-image.png", key });
            return;
        }
        renderProduct({ ...data, key });
    } catch (e) {
        console.error(e);
    }
}

// ‚úÖ Render products theo pagination
async function renderProductsPage(page) {
    productContainer.innerHTML = '';
    const start = (page - 1) * productsPerPage;
    const end = start + productsPerPage;
    const pageItems = filteredProducts.slice(start, end);

    // T·∫°o ID render m·ªõi
    const currentSession = ++renderSessionId;

    // üü° N·∫øu kh√¥ng c√≥ s·∫£n ph·∫©m
    if (pageItems.length === 0) {
        productContainer.innerHTML = `
            <div class="no-products">
                <p>üö´ Hi·ªán t·∫°i ch∆∞a c√≥ s·∫£n ph·∫©m n√†o cho danh m·ª•c n√†y.</p>
            </div>
        `;
        paginationContainer.innerHTML = '';
        return;
    }

    // üü¢ Hi·ªÉn th·ªã "ƒëang t·∫£i" (tu·ª≥ ch·ªçn)
    productContainer.innerHTML = `<div class="loading">‚è≥ ƒêang t·∫£i s·∫£n ph·∫©m...</div>`;

    // D·ª´ng m·ªôt nh·ªãp nh·ªè ƒë·ªÉ hi·ªÉn th·ªã loading
    await new Promise(r => setTimeout(r, 100));

    // L√†m tr·ªëng container sau khi b·∫Øt ƒë·∫ßu t·∫£i
    productContainer.innerHTML = '';

    // üü¢ Ch·ªâ render n·∫øu session n√†y c√≤n h·ª£p l·ªá
    const promises = pageItems.map(async (product) => {
        // N·∫øu user ƒë√£ ƒë·ªïi tag ‚Üí b·ªè qua render
        if (currentSession !== renderSessionId) return;
        await fetchAndRender(product.url, product.key);
    });

    await Promise.all(promises);

    // N·∫øu trong l√∫c ch·ªù user ƒë√£ ƒë·ªïi tag ‚Üí kh√¥ng render pagination
    if (currentSession !== renderSessionId) return;

    renderPagination();
}


// ‚úÖ Render pagination
function renderPagination() {
    const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
    let html = '';

    if (totalPages <= 1) {
        paginationContainer.innerHTML = '';
        return;
    }

    if (currentPage > 1) html += `<button onclick="goToPage(${currentPage - 1})">¬´ Tr∆∞·ªõc</button>`;
    for (let i = 1; i <= totalPages; i++) {
        html += `<button onclick="goToPage(${i})" ${i === currentPage ? 'style="font-weight:bold"' : ''}>${i}</button>`;
    }
    if (currentPage < totalPages) html += `<button onclick="goToPage(${currentPage + 1})">Sau ¬ª</button>`;

    paginationContainer.innerHTML = html;
}

// ‚úÖ Chuy·ªÉn trang
function goToPage(page) {
    currentPage = page;
    renderProductsPage(page);
}

// ‚úÖ Filter products
function filterProductsByKey(key) {
    filteredProducts = key ? productsData.filter(p => p.key === key) : [...productsData];
    currentPage = 1;
    renderProductsPage(currentPage);
}

// ‚úÖ Search
searchForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const query = searchInput.value.trim().toLowerCase();
    filteredProducts = productsData.filter(p => {
        const title = (p.title || '').toLowerCase();
        const url = (p.url || '').toLowerCase();
        const key = (p.key || '').toLowerCase();
        return !query || title.includes(query) || url.includes(query) || key.includes(query);
    });
    currentPage = 1;
    renderProductsPage(currentPage);
});

// ‚úÖ Load products t·ª´ JSON
async function loadProducts() {
    try {
        const res = await fetch("json/products.json");
        const data = await res.json();
        productsData = data.products || [];
        filteredProducts = [...productsData];
        await renderProductsPage(currentPage);
    } catch (err) {
        console.error("L·ªói khi t·∫£i danh s√°ch s·∫£n ph·∫©m:", err);
    }
}

// ‚úÖ Load tags
async function loadTags() {
    try {
        const res = await fetch('json/tags.json');
        const data = await res.json();
        const tagsArray = data.tags || [];
        const maxVisible = 1;

        let tagHtml = `<div class="tag active" data-key="">T·∫•t c·∫£</div>`;
        tagsArray.forEach((tag, index) => {
            const hiddenClass = index >= maxVisible ? 'hidden-tag' : '';
            tagHtml += `<div class="tag ${hiddenClass}" data-key="${tag.key}">${tag.name}</div>`;
        });

        tagContainer.innerHTML = tagHtml;

        tagContainer.querySelectorAll('.tag').forEach(tag => {
            tag.addEventListener('click', () => {
                filterProductsByKey(tag.dataset.key);
                tagContainer.querySelectorAll('.tag').forEach(t => t.classList.remove('active'));
                tag.classList.add('active');
            });
        });

        const toggleBtn = document.getElementById('toggleTags');
        toggleBtn?.addEventListener('click', () => {
            tagContainer.querySelectorAll('.tag.hidden-tag').forEach(t => t.classList.toggle('show-hidden'));
            const textDiv = toggleBtn.querySelector('.text');
            if (textDiv.textContent === 'Xem th√™m') {
                textDiv.textContent = 'Thu g·ªçn';
                toggleBtn.querySelector('.arr-down').classList.add('open');
            } else {
                textDiv.textContent = 'Xem th√™m';
                toggleBtn.querySelector('.arr-down').classList.remove('open');
            }
        });
    } catch (err) {
        console.error('L·ªói khi t·∫£i tags:', err);
    }
}

// üöÄ Kh·ªüi ch·∫°y
window.addEventListener('DOMContentLoaded', async () => {
    await loadTags();
    await loadProducts();
});
</script>
</html>
